<%- include("../../../partials/header-log") %>

  <!-- CONTENT -->
  <div class="backtest mx-auto pt-5 mb-5">
    <div class="journal-box px-0">
      <form action="/<%= currentUser.username %>/journal/backtest/<%= backtest.id %>?_method=PUT" method="POST">
        <input type="hidden" id="obj" name="serverData">
        <h3 class="mx-3"><%= backtest.date %><span class="backtest-result"><%= backtest.result %></span></h3>
        <hr>
        <!-- backtest edit modal -->
        <div class="modal modal-row fade" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title mx-auto orange"><%= __('Backtest Row') %></h5>
              </div>
              <div class="modal-body d-flex flex-column align-items-start modal-fields">
                <div class="mb-1 w-100">
                  <label class="mb-0"><%= __('Trade number') %>:</label>
                  <span id="row-index">
                    <strong><%= data[0].length + 1 %></strong>
                  </span>
                </div>
                <div class="d-flex w-100 mb-1">
                  <label class="mb-0"><%= __('Direction') %>:</label>
                  <!-- dropdown -->
                  <div class="dropdown modal-input">
                    <button id="dropdown-label" class="direction dropdown-select w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <% if ('direction' in backtest) { %>
                        <%= __(backtest.direction) %>
                      <% } else { %>
                        <%= __('Long') %>
                      <% } %>
                    </button>
                    <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                      <input class="dropdown-search d-none" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                      <% if ('direction' in backtest) { %>
                        <li><%= __(backtest.direction) %></li>
                      <% } else { %>
                        <li><%= __('Long') %></li>
                        <li><%= __('Short') %></li>
                      <% } %>
                    </ul>
                  </div>
                </div>
                <div class="d-flex w-100 mb-1">
                  <label class="mb-0"><%= __('Pair') %>:</label>
                  <!-- dropdown -->
                  <div class="dropdown modal-input ">
                    <button id="dropdown-label" class="pair dropdown-select w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <% if ('pair' in backtest) { %>
                        <%= currencies[Number(backtest.pair) - 1] %>
                      <% } else { %>
                        <%= currencies[0] %>
                      <% } %>
                    </button>
                    <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                      <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                      <% if ('pair' in backtest) { %>
                        <li><%= currencies[Number(backtest.pair) - 1] %></li>
                      <% } else { %>
                        <% for (var i = 0; i < currencies.length; i++) { %>
                          <li><%= currencies[i] %></li>
                        <% } %>
                      <% } %>
                    </ul>
                  </div>
                </div>
                <div class="d-flex w-100 mb-1">
                  <label class="mb-0"><%= ('Outcome') %>:</label>
                  <input type="number" id="row-result" class="modal-input py-0 px-2" placeholder="In <%= backtest.result %>">
                </div>
                <div class="d-flex w-100 mb-1">
                  <label class="mb-0"><%= __('Strategy') %>:</label>
                  <!-- dropdown -->
                  <div class="dropdown modal-input">
                    <button id="dropdown-label" class="strategy dropdown-select w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <% if ('strategy' in backtest) { %>
                        <%= backtest.strategy %>
                      <% } else { %>
                        <%= strategies[0] %>
                      <% } %>
                    </button>
                    <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                      <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                      <% if ('strategy' in backtest) { %>
                        <li><%= backtest.strategy %></li>
                      <% } else { %>
                        <% for (var i = 0; i < strategies.length; i++) { %>
                          <li><%= strategies[i] %></li>
                        <% } %>
                      <% } %>
                    </ul>
                  </div>
                </div>
                <div class="d-flex w-100 mb-1">
                  <label class="mb-0"><%= __('Timeframe') %>:</label>
                  <!-- dropdown -->
                  <div class="dropdown modal-input">
                    <button id="dropdown-label" class="timeframe dropdown-select w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <% if ('timeframe' in backtest) { %>
                        <%= timeframes[Number(backtest.timeframe) - 1] %>
                      <% } else { %>
                        <%= timeframes[0] %>
                      <% } %>
                    </button>
                    <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                      <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                      <% if ('timeframe' in backtest) { %>
                        <li><%= timeframes[Number(backtest.timeframe) - 1] %></li>
                      <% } else { %>
                        <% for (var i = 0; i < timeframes.length; i++) { %>
                          <li><%= timeframes[i] %></li>
                        <% } %>
                      <% } %>
                    </ul>
                  </div>
                </div>
                <p class="border-bottom my-2 w-100"><strong>Addons</strong></p>
                <% for (var i = 0; i < backtest.addons.length; i++) { %>
                  <div class="d-flex w-100 mb-1">
                    <label class="mb-0"><%= backtest.addons[i] %>:</label>
                    <% if (backtest.addonsType[i] == 1) { %>
                      <input type="number" class="addon modal-input py-0 px-2" step="0.01">
                    <% } else { %>
                      <!-- dropdown -->
                      <div class="dropdown modal-input">
                        <button id="dropdown-label" class="addon dropdown-select w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <%= backtest.addonsOptions[i][0] %>
                        </button>
                        <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                          <% for (var o = 0; o < 6; o++) { %>
                            <% if (backtest.addonsOptions[i][o] != null) { %>
                              <li><%= backtest.addonsOptions[i][o] %></li>
                            <% } %>
                          <% } %>
                        </ul>
                      </div>
                    <% } %>
                  </div>
                <% } %>
                <div class="align-self-end mt-3">
                  <button id="update-row" type="button" class="btn-neilit" onclick="updateRow()" data-dismiss="modal"><%= __('Edit') %></button>
                  <button id="create-row" type="button" class="btn-neilit" onclick="createRow()" data-dismiss="modal"><%= __('Create') %></button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mx-3">
          <div class="d-flex justify-content-between mb-1">
            <div class="">
              <h3><%= __('Backtest Table') %></h3>
              <label><%= __('Count') %>:
                <span id="table-count"></span>
              </label>
            </div>
            <div>
              <button type="button" class="btn-inverted mb-0" data-toggle="modal" data-target=".modal-row" onclick="cleanModal()"><%= __('New') %></button>
            </div>
          </div>

          <div class="table-responsive-md">
            <table id="backtest-table" class="table table-sm">
              <thead>
                <tr class="table-header">
                  <th scope="col">#</th>
                  <th scope="col"><%= __('Direction') %></th>
                  <th scope="col"><%= __('Result') %></th>
                  <th scope="col"><%= __('Pair') %></th>
                  <th scope="col"><%= __('Strategy') %></th>
                  <th scope="col"><%= __('Timeframe') %></th>
                  <% if ('addons' in backtest) { %>
                    <% backtest.addons.forEach((addon, i) => { %>
                      <th scope="col" class="non-wrap" data-toggle="tooltip" data-placement="top" title="<%= addon %>"><%= __('Addon') %> <%= i + 1 %></th>
                    <% }) %>
                  <% } %>
                  <th scope="col"><%= __('Action') %></th>
                </tr>
              </thead>
              <tbody>
                <% data[1].forEach((result, i) => { %>
                  <tr>
                    <td><%= i + 1 %></td>
                    <td>
                      <% if ('direction' in backtest) { %>
                        <%= __(backtest.direction) %>
                      <% } else { %>
                        <%= __(data[0][i]) %>
                      <% } %>
                    </td>
                    <td class="text-right"><%= result.toFixed(2) %> <%= backtest.result %></td>
                    <td>
                      <% if ('pair' in backtest) { %>
                        <%= currencies[Number(backtest.pair) - 1] %>
                      <% } else { %>
                        <%= currencies[Number(data[2][i]) -1] %>
                      <% } %>
                    </td>
                    <td class="non-wrap">
                      <% if ('strategy' in backtest) { %>
                        <%= backtest.strategy %>
                      <% } else { %>
                        <%= data[3][i] %>
                      <% } %>
                    </td>
                    <td>
                      <% if ('timeframe' in backtest) { %>
                        <%= timeframes[Number(backtest.timeframe) - 1] %>
                      <% } else { %>
                        <%= timeframes[Number(data[4][i]) - 1] %>
                      <% } %>
                    </td>
                    <% if ('addons' in backtest) { %>
                      <% backtest.addons.forEach((col, n) => { %>
                        <td>
                          <%= data[n + 5][i] %>
                        </td>
                      <% }) %>
                    <% } %>
                    <td class="text-center">
                      <button type="button" class="table-action delete-row" onclick="deleteRow(this)">
                        <img src="/imgs/icons/delete.svg" alt="delete row">
                      </button>
                      <button type="button" class="table-action edit-row" data-toggle="modal" data-target=".modal-row" onclick="editRow(this);">
                        <img src="/imgs/icons/edit.svg" alt="edit row">
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
        <br>
        <div class="d-flex justify-content-end mx-3">
          <a href="javascript:history.back()" class="btn-inverted ml-2"><%= __('Cancel') %></a>
          <button type="submit" id="update-backtest" class="btn-neilit ml-2"><%= __('Save') %></button>
        </div>
      </form>
    </div>
  </div>

<script type="text/javascript">
  var currencies = <%- JSON.stringify(currencies) %>;
  var timeframes = <%- JSON.stringify(timeframes) %>;
  var strategies = <%- JSON.stringify(strategies) %>;
  var backtest = <%- JSON.stringify(backtest) %>;
  var data = <%- JSON.stringify(data) %>;
</script>

<!-- <section> is inside partials -->
</section>

<!-- JQUERY -->
<script type="text/javascript" src="/utilities/jquery/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/popper.min.js"></script>
<script type="text/javascript" src="/utilities/jquery/jquery-ui.min.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/bootstrap.min.js"></script>
<!-- LOCAL SCRIPTS -->
<script type="text/javascript" src="/js/backtest.js"></script>

<%- include("../../../partials/footer-log") %>
