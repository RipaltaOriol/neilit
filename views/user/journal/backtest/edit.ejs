<%- include("../../../partials/header-log") %>

  <!-- CONTENT -->
  <div class="backtest mt-3 mb-5 mx-auto">
    <div class="journal-box px-0">
      <form action="/<%= currentUser.username %>/journal/backtest/<%= backtest.id %>?_method=PUT" method="POST">
        <input type="hidden" id="obj" name="serverData">
        <h3 class="mx-3"><%= backtest.title %></h3>
        <hr>
        <div class="form-row mx-3">
          <div class="col-auto mr-3 mb-2">
            <label class="mb-0"><%= __('Trade number') %></label>
            <h5 id="row-index" class="text-right p-2 bg-hover">
              <%= data[0].length + 1 %>
            </h5>
          </div>
          <div class="col-auto mr-3 mb-2">
            <label class="mb-0"><%= __('Direction') %></label>
            <!-- dropdown -->
            <div class="dropdown">
              <button id="dropdown-label" class="direction dropdown-select p-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <% if ('direction' in backtest) { %>
                  <%= backtest.direction %>
                <% } else { %>
                  <%= __('long') %>
                <% } %>
              </button>
              <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                <input class="dropdown-search d-none" type="text" placeholder="Search..." onkeyup="searchDropdown(this)">
                <% if ('direction' in backtest) { %>
                  <li><%= backtest.direction %></li>
                <% } else { %>
                  <li><%= __('long') %></li>
                  <li><%= __('short') %></li>
                <% } %>
              </ul>
            </div>
          </div>
          <div class="col-auto mr-3 mb-2">
            <label class="mb-0"><%= __('Pair') %></label>
            <!-- dropdown -->
            <div class="dropdown">
              <button id="dropdown-label" class="pair dropdown-select p-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <% if ('pair' in backtest) { %>
                  <%= currencies[Number(backtest.pair) - 1] %>
                <% } else { %>
                  <%= currencies[0] %>
                <% } %>
              </button>
              <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                <input class="dropdown-search p-2 w-100" type="text" placeholder="Search..." onkeyup="searchDropdown(this)">
                <% if ('pair' in backtest) { %>
                  <li><%= currencies[Number(backtest.pair) - 1] %></li>
                <% } else { %>
                  <% for (var i = 0; i < currencies.length; i++) { %>
                    <li><%= currencies[i] %></li>
                  <% } %>
                <% } %>
              </ul>
            </div>
          </div>
          <div class="col-auto mb-2">
            <label class="mb-0"><%= ('Outcome') %></label>
            <input type="number" id="row-result" class="d-block bg-hover p-2">
          </div>
        </div>
        <div class="form-row mx-3">
          <div class="col-auto mr-3 mb-2">
            <label class="mb-0"><%= __('Strategy') %></label>
            <!-- dropdown -->
            <div class="dropdown">
              <button id="dropdown-label" class="strategy dropdown-select p-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <% if ('strategy' in backtest) { %>
                  <%= backtest.strategy %>
                <% } else { %>
                  <%= strategies[0] %>
                <% } %>
              </button>
              <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                <input class="dropdown-search p-2 w-100" type="text" placeholder="Search..." onkeyup="searchDropdown(this)">
                <% if ('strategy' in backtest) { %>
                  <li><%= backtest.strategy %></li>
                <% } else { %>
                  <% for (var i = 0; i < strategies.length; i++) { %>
                    <li><%= strategies[i] %></li>
                  <% } %>
                <% } %>
              </ul>
            </div>
          </div>
          <div class="col-auto mr-3 mb-2">
            <label class="mb-0"><% __('Timeframe') %></label>
            <!-- dropdown -->
            <div class="dropdown">
              <button id="dropdown-label" class="timeframe dropdown-select p-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <% if ('timeframe' in backtest) { %>
                  <%= timeframes[Number(backtest.timeframe) - 1] %>
                <% } else { %>
                  <%= timeframes[0] %>
                <% } %>
              </button>
              <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                <input class="dropdown-search p-2 w-100" type="text" placeholder="Search..." onkeyup="searchDropdown(this)">
                <% if ('timeframe' in backtest) { %>
                  <li><%= timeframes[Number(backtest.timeframe) - 1] %></li>
                <% } else { %>
                  <% for (var i = 0; i < timeframes.length; i++) { %>
                    <li><%= timeframes[i] %></li>
                  <% } %>
                <% } %>
              </ul>
            </div>
          </div>
          <div class="col-auto mt-auto mb-2">
            <button id="update-row" type="button" class="btn-neilit mb-0 d-none" onclick="updateRow()"><%= __('Edit') %></button>
            <button id="new-row" type="button" class="btn-inverted mb-0 d-none" onclick="newRow(1)"><%= __('New') %></button>
            <button id="create-row" type="button" class="btn-neilit mb-0 d-inline" onclick="createRow()"><%= __('Create') %></button>
          </div>
        </div>
        <% if ('addons' in backtest) { %>
          <div class="form-row mx-3 mt-3">
            <% for (var i = 0; i < backtest.addons.length; i++) { %>
              <div class="col-auto mr-3 mb-2">
                <label class="mb-0"><%= backtest.addons[i] %></label>
                <% if (backtest.addonsType[i] == 1) { %>
                  <input type="number" class="addon d-block bg-hover p-2" step="0.01">
                <% } else { %>
                  <!-- dropdown -->
                  <div class="dropdown">
                    <button id="dropdown-label" class="addon dropdown-select p-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <%= backtest.addonsOptions[i][0] %>
                    </button>
                    <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                      <% for (var o = 0; o < 6; o++) { %>
                        <% if (backtest.addonsOptions[i][o] != null) { %>
                          <li><%= backtest.addonsOptions[i][o] %></li>
                        <% } %>
                      <% } %>
                    </ul>
                  </div>
                <% } %>
              </div>
            <% } %>
          </div>
        <% } %>
        <br>
        <h3 class="mx-3"><%= __('Backtest Table') %></h3>
        <hr>
        <div class="mx-3">
          <label><%= __('Count') %>:
            <span id="table-count"></span>
          </label>
          <div class="table-responsive-md">
            <table id="backtest-table" class="table table-sm">
              <thead>
                <tr class="table-header">
                  <th scope="col">#</th>
                  <th scope="col"><%= __('Direction') %></th>
                  <th scope="col"><%= __('Result') %></th>
                  <th scope="col"><%= __('Pair') %></th>
                  <th scope="col"><%= __('Strategy') %></th>
                  <th scope="col"><%= __('Timeframe') %></th>
                  <% if ('addons' in backtest) { %>
                    <% backtest.addons.forEach((addon, i) => { %>
                      <th scope="col" class="non-wrap" data-toggle="tooltip" data-placement="top" title="<%= addon %>"><%= __('Addon') %> <%= i + 1 %></th>
                    <% }) %>
                  <% } %>
                  <th scope="col"><%= __('Action') %></th>
                </tr>
              </thead>
              <tbody>
                <% data[1].forEach((result, i) => { %>
                  <tr>
                    <td><%= i + 1 %></td>
                    <td>
                      <% if ('direction' in backtest) { %>
                        <%= backtest.direction %>
                      <% } else { %>
                        <%= data[0][i] %>
                      <% } %>
                    </td>
                    <td class="text-right"><%= result %></td>
                    <td>
                      <% if ('pair' in backtest) { %>
                        <%= currencies[Number(backtest.pair) - 1] %>
                      <% } else { %>
                        <%= currencies[Number(data[2][i]) -1] %>
                      <% } %>
                    </td>
                    <td class="non-wrap">
                      <% if ('strategy' in backtest) { %>
                        <%= backtest.strategy %>
                      <% } else { %>
                        <%= data[3][i] %>
                      <% } %>
                    </td>
                    <td>
                      <% if ('timeframe' in backtest) { %>
                        <%= timeframes[Number(backtest.timeframe) - 1] %>
                      <% } else { %>
                        <%= timeframes[Number(data[4][i]) - 1] %>
                      <% } %>
                    </td>
                    <% if ('addons' in backtest) { %>
                      <% backtest.addons.forEach((col, n) => { %>
                        <td class="text-right">
                          <%= data[n + 5][i] %>
                        </td>
                      <% }) %>
                    <% } %>
                    <td class="text-center">
                      <button type="button" class="table-action delete-row" onclick="deleteRow(this)">
                        <img src="/imgs/icons/delete.svg" alt="delete row">
                      </button>
                      <button type="button" class="table-action edit-row" onclick="editRow(this);">
                        <img src="/imgs/icons/edit.svg" alt="edit row">
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
        <br>
        <div class="d-flex justify-content-end mx-3">
          <a href="javascript:history.back()" class="btn-inverted ml-2"><%= __('Cancel') %></a>
          <button type="submit" id="update-backtest" class="btn-neilit ml-2"><%= __('Save') %></button>
        </div>
      </form>
    </div>
  </div>

<script type="text/javascript">
  var currencies = <%- JSON.stringify(currencies) %>;
  var timeframes = <%- JSON.stringify(timeframes) %>;
  var strategies = <%- JSON.stringify(strategies) %>;
  var backtest = <%- JSON.stringify(backtest) %>;
  var data = <%- JSON.stringify(data) %>;
</script>

<!-- <section> is inside partials -->
</section>

<!-- JQUERY -->
<script type="text/javascript" src="/utilities/jquery/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/popper.min.js"></script>
<script type="text/javascript" src="/utilities/jquery/jquery-ui.min.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/bootstrap.min.js"></script>
<!-- LOCAL SCRIPTS -->
<script type="text/javascript" src="/js/backtest.js"></script>

<%- include("../../../partials/footer-log") %>
