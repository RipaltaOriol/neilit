<%- include("../../../partials/header-log") %>

  <!-- CONTENT -->
  <div class="container mx-auto mb-5">
    <div class="journal-box px-0 entry-input">
      <form action="/<%= currentUser.username %>/journal/entry/<%= entryInfo.id %>?_method=PUT" method="POST" novalidate class="validate-form" id="entry-form">
        <h3 class="mx-3"><%= entryInfo.pair %> - <%= entryInfo.entry_dt.toLocaleDateString(currentUser.language, options) %></h3>
        <hr>
        <div class="mb-2 mx-3">
          <div class="d-flex flex-column mt-2 p-2 form-fields">
            <h5><%= __('Specific') %></h5>
            <span class="mb-2 d-block">
              <label class="mandatory"><%= __('Pair') %>:</label>
              <input type="text" name="pair" value="<%= entryInfo.pair_id %>" class="dropdown-server d-none">
              <!-- dropdown -->
              <div class="dropdown d-inline">
                <button id="dropdown-label" class="dropdown-select p-2" type="button" data-toggle="dropdown">
                  <%= entryInfo.pair %>
                </button>
                <ul id="dropdown-items" class="dropdown-menu dropdown-asset" aria-labelledby="dropdown-label">
                  <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                  <% Object.keys(currencies).forEach((key) => { %>
                    <li class="<%= currencies[key].id %>"><%= key %></li>
                  <% }) %>
                </ul>
              </div>
            </span>
            <span class="mb-2 d-block">
              <label class="mandatory"><%= __('Category') %>:</label>
              <input id="category" type="text" class="form-input orange p-1 px-2" name="category" value="<%= entryInfo.category %>" readonly>
            </span>
            <span class="mb-2 d-block">
              <label class="mandatory"><%= __('Strategy') %>:</label>
              <input type="text" name="strategy" value="<%= entryInfo.strategy_id %>" class="dropdown-server d-none">
              <!-- dropdown -->
              <div class="dropdown d-inline">
                <button id="dropdown-label" class="dropdown-select p-2" type="button" data-toggle="dropdown">
                  <%= entryInfo.strategy %>
                </button>
                <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                  <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                  <% for (var i = 0; i < strategies.length; i++) { %>
                    <li class="<%= strategiesID[i] %>"><%= strategies[i] %></li>
                  <% } %>
                </ul>
              </div>
            </span>
            <span class="d-block">
              <label class="mandatory"><%= __('Timeframe') %>:</label>
              <input type="text" name="timeframe" value="<%= entryInfo.timeframe_id %>" class="dropdown-server d-none">
              <!-- dropdown -->
              <div class="dropdown d-inline">
                <button id="dropdown-label" class="dropdown-select p-2" type="button" data-toggle="dropdown">
                  <%= entryInfo.timeframe %>
                </button>
                <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                  <input class="dropdown-search p-2 w-100" type="text" placeholder="<%= __('Search') %>..." onkeyup="searchDropdown(this)">
                  <% for (var i = 0; i < timeframes.length; i++) { %>
                    <li class="<%= i + 1 %>"><%= timeframes[i] %></li>
                  <% } %>
                </ul>
              </div>
            </span>
          </div>
          <div class="d-flex flex-column mt-2 p-2 form-fields">
            <h5><%= __('Finance') %></h5>
            <div class="mt-2">
              <span class="input-group mb-2">
                <label class="my-auto mandatory"><%= __('Size') %>:</label>
                <input type="number" class="form-control form-input p-1 px-2" name="size" min="0" step="0.001" value="<%= entryInfo.size %>" required>
              </span>
              <span class="input-group mb-2">
                <label class="my-auto mandatory"><%= __('Entry Price') %>:</label>
                <input type="number" class="form-control form-input p-1 px-2" name="entryPrice" min="0" step="0.00001" value="<%= entryInfo.entry_price %>" required>
              </span>
              <span class="input-group mb-2">
                <label class="my-auto"><%= __('Stop Loss') %>:</label>
                <input type="number" class="form-control form-input p-1 px-2" name="stopLoss" min="0" step="0.00001" value="<%= entryInfo.stop_loss %>">
              </span>
              <span class="input-group">
                <label class="my-auto"><%= __('Take Profit') %>:</label>
                <input type="number" class="form-control form-input p-1 px-2" name="takeProfit" min="0" step="0.00001" value="<%= entryInfo.take_profit %>">
              </span>
            </div>
          </div>
          <div class="d-flex flex-column mt-2 p-2 form-fields">
            <h5><%= __('Logistics') %></h5>
            <div class="info-fields mt-2">
              <span class="input-group mb-2">
                <label class="my-auto mandatory"><%= __('Date of Entry') %>:</label>
                <input type="text" class="datepicker form-control form-input p-1 px-2" data-target="entry-date" value="<%= entryInfo.entry_dt.toLocaleDateString(currentUser.language, options) %>" required>
                <input type="text" id="entry-date" class="d-none" name="entryDate" value="<%= entryInfo.open_format %>">
              </span>
              <span class="input-group mb-2">
                <label class="my-auto"><%= __('Time of Entry') %>:</label>
                <input id="entry-time" type="text" class="form-control form-input p-1 px-2" name="entryTime" value="<%= entryInfo.entry_dt.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' }) %>">
              </span>
              <span class="mb-2">
                <div class="form-check form-check-inline">
                  <label class="checkbox-orange mb-0 mandatory">
                    <%= __('Long') %>
                    <% if (entryInfo.direction === 'long') { %>
                      <input type="radio" name="direction" value="1" required checked>
                    <% } else { %>
                      <input type="radio" name="direction" value="1" required>
                    <% } %>
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <label class="checkbox-orange mb-0 mandatory">
                    <%= __('Short') %>
                    <% if (entryInfo.direction === 'short') { %>
                      <input type="radio" name="direction" value="-1" required checked>
                    <% } else { %>
                      <input type="radio" name="direction" value="-1" required>
                    <% } %>
                    <span class="checkmark"></span>
                  </label>
                </div>
              </span>
            </div>
          </div>
        </div>
        <br>
        <h3 class="mx-3"><%= ('Connect a Technical Analysis') %></h3>
        <hr>
        <div class="mx-3">
          <span class="d-block">
            <label class="checkbox-orange mb-0">
              <%= __('Entry without a Technical Analysis') %>
              <% if (entryInfo.ta_id != null) { %>
                <input id="noneTa" type="radio" name="selectTa" value="none">
              <% } else { %>
                <input id="noneTa" type="radio" name="selectTa" value="none" checked>
              <% } %>
              <span class="checkmark"></span>
            </label>
          </span>
          <span class="d-block">
            <label class="checkbox-orange mb-0">
              <%= __('Connect a Technical Analysis') %>
              <% if (entryInfo.ta_id) { %>
                <input id="selectTa" type="radio" name="selectTa" value="select" data-toggle="modal" data-target=".modal-ta" checked>
              <% } else { %>
                <input id="selectTa" type="radio" name="selectTa" value="select" data-toggle="modal" data-target=".modal-ta">
              <% } %>
              <span class="checkmark"></span>
            </label>
          </span>
          <% if (entryInfo.ta_id != null) { %>
            <span id="entry-ta">
              <label class="mt-2 mb-0"><strong><%= __('Entry connected to') %>:</strong></label>
              <% for (var i = 0; i < technicalAnalysis.length; i++) { %>
                <% if (entryInfo.ta_id === technicalAnalysis[i].id) { %>
                  <p id="connect-ta" class="d-inline bg-hover orange px-2"><%= technicalAnalysis[i].pair %> -
                    <%= new Date(technicalAnalysis[i].created_at).toLocaleDateString(currentUser.language, options) %></p>
                  <input id="ta" type="text" name="entryTa" class="d-none" value="<%= technicalAnalysis[i].id %>">
                <% } %>
              <% } %>
            </span>
          <% } else { %>
            <span id="entry-ta" class="d-none">
              <label class="mt-2 mb-0"><strong><%= __('Entry connected to') %>:</strong></label>
              <p id="connect-ta" class="d-inline bg-hover orange px-2"></p>
              <input id="ta" type="text" name="entryTa" class="d-none">
            </span>
          <% } %>
        </div>
        <!-- technical analysis modal -->
        <div class="modal modal-ta fade" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content text-center">
              <div class="modal-header">
                <h5 class="modal-title mx-auto"><%= __('Select a') %> <span class="orange"><%= __('Technical Analysis') %></span> <%= __('to connect to this entry') %></h5>
              </div>
              <div class="modal-body d-flex flex-column">
                <% technicalAnalysis.forEach((ta, i) => { %>
                  <a class="mt-2 bg-hover" data-dismiss="modal" onclick="connectTa(<%= i %>);"><%= ta.pair %> - <%= ta.created_at.toLocaleDateString(currentUser.language, options) %></a>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
        <br>
        <h3 class="mx-3"><%= __('Comments') %></h3>
        <hr>
        <div class="mx-3">
          <div id="client-comment" class="editcontent p-2" placeholder="<%= __('Use this spece to write anything outstanding during the operation') %>" contenteditable="true"><%- entryInfo.comment %></div>
        </div>
        <textarea id="server-comment" name="comment" class="d-none" value="<%= entryInfo.comment %>"></textarea>
        <br>
        <h3 class="mx-3"><%= __('Close Entry') %></h3>
        <hr>
        <div class="mx-3 mb-3">
          <span class="d-block">
            <label class="checkbox-orange mb-0 font-18">
              <%= __('The operation remains open') %>
              <% if (!entryInfo.status) { %>
                <input id="entry-open" type="radio" name="status" value="0" onclick="displayClose(this.value)" checked>
              <% } else { %>
                <input id="entry-open" type="radio" name="status" value="0" onclick="displayClose(this.value)">
              <% } %>
              <span class="checkmark"></span>
            </label>
          </span>
          <span class="d-block">
            <label class="checkbox-orange mb-0">
              <%= __('The operation is closed') %>
              <% if (!entryInfo.status) { %>
                <input id="entry-close" type="radio" name="status" value="1" onclick="displayClose(this.value)">
              <% } else { %>
                <input id="entry-close" type="radio" name="status" value="1" onclick="displayClose(this.value)" checked>
              <% } %>
              <span class="checkmark"></span>
            </label>
          </span>
        </div>
        <% if (!entryInfo.status) { %>
          <div id="entry-closure" class="flex-column d-none mx-3 form-fields">
            <span class="input-group mb-2">
              <label class="my-auto mr-1"><%= __('Exit Date') %>:</label>
              <input type="text" class="datepicker form-control form-input p-1 px-2" data-target="exit-date">
              <input type="text" id="exit-date" class="d-none" name="exitDate">
            </span>
            <span class="input-group mb-2">
              <label class="my-auto mr-1 mandatory"><%= __('Exit Price') %>:</label>
              <input type="number" class="form-control form-input p-1 px-2" name="closePrice" min="0" step="0.00001">
            </span>
            <span class="input-group mb-2">
              <label class="my-auto mr-1"><%= __('Profits') %>:</label>
              <input type="number" class="form-control form-input p-1 px-2" name="profits" placeholder="<%= __('In account\'s currency') %>: <%= __(currency) %>" step="0.0001">
              <span class="ml-2 my-auto">
                <img class="info" src="/imgs/icons/info.svg" data-toggle="tooltip" data-placement="right" title="<%= __('In case of leaving this field blank, Neilit will calculate the profits of the operation for you.') %>'">
              </span>
            </span>
            <span class="input-group mb-2">
              <label class="my-auto mr-1"><%= __('Fees') %>:</label>
              <input type="number" class="form-control form-input p-1 px-2" name="fees" placeholder="<%= __('In account\'s currency') %>: <%= __(currency) %>" step="0.01">
            </span>
            <span class="mb-2 d-block">
              <label class="mandatory"><%= __('Results') %>:</label>
              <input type="text" name="result" value="win" class="dropdown-server d-none">
              <div class="dropdown d-inline">
                <button id="dropdown-label" class="dropdown-select p-2" type="button" data-toggle="dropdown">
                  <%= __('Win') %>
                </button>
                <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                  <li class="win"><%= __('Win') %></li>
                  <li class="loss"><%= __('Loss') %></li>
                  <li class="be"><%= __('Break Even') %></li>
                </ul>
              </div>
            </span>
          </div>
        <% } else { %>
          <div id="entry-closure" class="d-flex flex-column mx-3 form-fields">
            <span class="input-group mb-2">
              <label class="my-auto mr-1"><%= __('Exit Date') %>:</label>
              <% if (entryInfo.exit_dt != null) { %>
                <input type="text" class="datepicker form-control form-input p-1 px-2" data-target="exit-date" value="<%= entryInfo.exit_dt.toLocaleDateString(currentUser.language, options) %>">
                <input type="text" id="exit-date" class="d-none" name="exitDate" value="<%= entryInfo.close_format %>">
              <% } else { %>
                <input type="text" class="datepicker form-control form-input p-1 px-2" data-target="exit-date">
                <input type="text" id="exit-date" class="d-none" name="exitDate">
              <% } %>
            </span>
            <span class="input-group mb-2">
              <label class="my-auto mr-1 mandatory"><%= __('Exit Price') %>:</label>
              <input type="number" class="form-control form-input p-1 px-2" name="closePrice" min="0" step="0.00001" value="<%= entryInfo.exit_price %>">
            </span>
            <span class="input-group mb-2">
            <label class="my-auto mr-1"><%= __('Profits') %>:</label>
            <input type="number" class="form-control form-input p-1 px-2" name="profits" placeholder="<%= __('In account\'s currency') %>: <%= __(currency) %>" step="0.0001" value="<%= entryInfo.profits %>">
            <span class="ml-2 my-auto">
              <img class="info" src="/imgs/icons/info.svg" data-toggle="tooltip" data-placement="right" title="<%= __('In case of leaving this field blank, Neilit will calculate the profits of the operation for you.') %>'">
            </span>
          </span>
          <span class="input-group mb-2">
            <label class="my-auto mr-1"><%= __('Fees') %>:</label>
            <input type="number" class="form-control form-input p-1 px-2" name="fees" placeholder="<%= __('In account\'s currency') %>: <%= __(currency) %>" step="0.01" value="<%= entryInfo.fees %>">
          </span>
          <span class="mb-2 d-block">
            <label class="mandatory"><%= __('Results') %>:</label>
            <input type="text" name="result" value="<%= entryInfo.result %>" class="dropdown-server d-none">
            <div class="dropdown d-inline">
              <button id="dropdown-label" class="dropdown-select p-2" type="button" data-toggle="dropdown">
                <% if (entryInfo.result == 'win') { %>
                  <%= __('Win') %>
                <% } else if (entryInfo.result == 'loss') { %>
                  <%= __('Loss') %>
                <% } else { %>
                  <%= __('Break Even') %>
                <% } %>
              </button>
              <ul id="dropdown-items" class="dropdown-menu" aria-labelledby="dropdown-label">
                <li class="win"><%= __('Win') %></li>
                <li class="loss"><%= __('Loss') %></li>
                <li class="be"><%= __('Break Even') %></li>
              </ul>
            </div>
          </span>
          </div>
        <% } %>
        <div class="d-flex justify-content-end mx-3">
          <a href="javascript:history.back()" class="btn-inverted ml-2"><%= __('Cancel') %></a>
          <button type="button" class="btn-neilit ml-2" data-toggle="modal" data-target=".modal-submit"><%= __('Save') %></button>
        </div>
        <!-- technical analysis modal -->
        <div id="modal-edit-alert" class="modal modal-submit fade" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content text-center p-4">
              <h5 class="modal-title mx-auto"><%= __('Altering existing fields might alter your current statistics') %></h5>
              <br>
              <button id="submit-entry" type="submit" class="btn-neilit"><%= __('Accept') %></button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- loading modal -->
  <div id="modal-loading" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content p-5">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">
  var language = <%- JSON.stringify(currentUser.language) %>;
  var currencies        = <%- JSON.stringify(currencies) %>;
  var technicalAnalysis = <%- JSON.stringify(technicalAnalysis) %>;
</script>

<!-- <section> is inside partials -->
</section>

<!-- JQUERY -->
<script type="text/javascript" src="/utilities/jquery/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/utilities/jquery/jquery-ui.min.js"></script>
<script type="text/javascript" src="/utilities/jquery/datepicker-es.js"></script>
<script type="text/javascript" src="/utilities/jquery/datepicker-en.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/popper.min.js"></script>
<script type="text/javascript" src="/utilities/bootstrap/js/bootstrap.min.js"></script>
<!-- LOCAL SCRIPTS -->
<script type="text/javascript" src="/js/entry.js"></script>

<%- include("../../../partials/footer-log") %>
